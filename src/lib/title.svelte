<script>
	import { allKeywords } from './shared.svelte'
	import { onMount } from 'svelte';
  import keyword_extractor from 'keyword-extractor';
  import gifmovie from '/src/kwapp720.gif';

	const spEndpoint = 'https://resource.geosphere.at/graphdb/repositories/WP9-TEST';
  const spFormat = 'Accept=application%2Fsparql-results%2Bjson';

  const spQuery = `PREFIX foaf: <http://xmlns.com/foaf/0.1/>
        PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
        SELECT DISTINCT ?uri ?p ?l (STRLEN(?l) AS ?len)
        (GROUP_CONCAT(DISTINCT ?t; separator=";") AS ?topic)
        FROM <https://data.geoscience.earth/ncl/geoera/keyword>
        FROM <https://topic>
        WHERE {
        VALUES ?p {skos:prefLabel skos:altLabel}
        ?uri ?p ?l . FILTER(LANG(?l)='en') 
        OPTIONAL {?uri foaf:primaryTopic ?t}
        } GROUP BY ?uri ?p ?l
        ORDER BY DESC (?len)`;

	onMount(() => {
    fetch(spEndpoint + '?query=' + encodeURIComponent(spQuery) + '&' + spFormat)
      .then(res => res.json())
      .then(a => allKeywords.arr = (a.results.bindings.map(b => ({
        label: b.l.value.toLowerCase(),
        newLabelArr: kwExtract(b.l.value, true),
        uri: b.uri.value,
        len: b.len.value,
        topic: b.topic.value
      }))))
      .then(a=>console.log(allKeywords.arr));
  });	

  const extractExceptions = ['well', 'causes'];
    function kwExtract(text, thes){
        text = text.replace(/\_|\"|\-|\.|\:|\//g,' ').toLowerCase();
        let someExist = extractExceptions.some(word => text.split(' ').includes(word));
        let kArr = keyword_extractor.extract(text, {
        language: "english",
        remove_digits: true,
        return_changed_case: true,
        remove_duplicates: false
        })
        // if keyword of thesaurus then without extraction
        return someExist ? thes ? text.split(' ') : text.split(' ').concat(kArr) : kArr;
    }

</script>


<h2 class="mb-4 text-3xl font-thin text-gray-900 dark:text-white md:text-5xl lg:text-6xl"><span class="text-transparent font-extrabold bg-clip-text bg-gradient-to-r to-emerald-600 from-sky-400">keyword</span> assistant</h2>
<div class="text-base font-normal text-gray-500 lg:text-base dark:text-gray-400">
  For automatic keywording with the "<strong>GeoERA Keyword Thesaurus v2.2</strong>", you can load content via CSV file or insert it directly into the text field. Depending on the configuration, the keywords (in English) are appended to the text lines with numbers or URIs “tab-delimited” by clicking on “add keywords”. Keywords can also be searched for manually (on the right-hand side) and inserted into the text field using drag and drop. The result can then be saved as a CSV file (tab-delimited).
  <span class="inline-flex">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h1.5C5.496 19.5 6 18.996 6 18.375m-3.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-1.5A1.125 1.125 0 0 1 18 18.375M20.625 4.5H3.375m17.25 0c.621 0 1.125.504 1.125 1.125M20.625 4.5h-1.5C18.504 4.5 18 5.004 18 5.625m3.75 0v1.5c0 .621-.504 1.125-1.125 1.125M3.375 4.5c-.621 0-1.125.504-1.125 1.125M3.375 4.5h1.5C5.496 4.5 6 5.004 6 5.625m-3.75 0v1.5c0 .621.504 1.125 1.125 1.125m0 0h1.5m-1.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m1.5-3.75C5.496 8.25 6 7.746 6 7.125v-1.5M4.875 8.25C5.496 8.25 6 8.754 6 9.375v1.5m0-5.25v5.25m0-5.25C6 5.004 6.504 4.5 7.125 4.5h9.75c.621 0 1.125.504 1.125 1.125m1.125 2.625h1.5m-1.5 0A1.125 1.125 0 0 1 18 7.125v-1.5m1.125 2.625c-.621 0-1.125.504-1.125 1.125v1.5m2.625-2.625c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125M18 5.625v5.25M7.125 12h9.75m-9.75 0A1.125 1.125 0 0 1 6 10.875M7.125 12C6.504 12 6 12.504 6 13.125m0-2.25C6 11.496 5.496 12 4.875 12M18 10.875c0 .621-.504 1.125-1.125 1.125M18 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m-12 5.25v-5.25m0 5.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125m-12 0v-1.5c0-.621-.504-1.125-1.125-1.125M18 18.375v-5.25m0 5.25v-1.5c0-.621.504-1.125 1.125-1.125M18 13.125v1.5c0 .621.504 1.125 1.125 1.125M18 13.125c0-.621.504-1.125 1.125-1.125M6 13.125v1.5c0 .621-.504 1.125-1.125 1.125M6 13.125C6 12.504 5.496 12 4.875 12m-1.5 0h1.5m-1.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M19.125 12h1.5m0 0c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h1.5m14.25 0h1.5" />
    </svg>
    &nbsp; 
    <details class="text-xs cursor-pointer">
      <summary></summary>
      <img class="rounded-t-lg" src={gifmovie} alt="" />
    </details>
  </span>
</div>




